---
import { sanityClient } from "sanity:client";
import HomeLayout from '../../layouts/HomeLayout.astro';
import HeroSection from './sections/hero.astro';
import CreeksideDifference from './sections/the-creekside-difference.astro';
import OurPillars from './sections/our-pillars.astro';
import NavigationGrid from './sections/navigation-grid.astro';
import Testimonials from './sections/testimonials.astro';
import CommunityImage from './sections/community-image.astro';
import { ASSETS_BASE_URL } from '../../constants';

const DEFAULT_IMAGES = {
  hero: {
    url: `${ASSETS_BASE_URL}/images/home--hero.jpg`,
    alt: 'Adult and child engaged in art activity at Creekside School',
  },
  creeksideDifference: {
    url: `${ASSETS_BASE_URL}/images/home--the-creekside-difference.jpg`,
    alt: 'Creekside School campus',
  },
  communityImage: {
    url: `${ASSETS_BASE_URL}/images/home--community.jpg`,
    alt: 'Community',
  },
};

function withDefaultImage(
  cmsImage: { asset?: { url: string }; alt?: string } | undefined,
  defaultImage: { url: string; alt: string }
) {
  if (cmsImage?.asset?.url) {
    return { asset: { url: cmsImage.asset.url }, alt: defaultImage.alt };
  }
  return { asset: { url: defaultImage.url }, alt: defaultImage.alt };
}

const QUERY = /* groq */ `*[_type == "home"][0] {
  title,
  heroText {
    image { asset->{ _id, url } },
    badge,
    headingPrefix,
    headingHighlight,
    subheading
  },
  creeksideDifferenceText {
    heading,
    body,
    image { asset->{ _id, url } }
  },
  ourPillarsText {
    heading,
    subheading,
    pillars[] {
      title,
      icon,
      text
    }
  },
  communityPartnersText {
    heading,
    partners[] {
      name,
      image { asset->{ _id, url } }
    }
  },
  navigationGridText {
    heading,
    linkLabel,
    items[] {
      title,
      icon,
      link
    }
  },
  testimonialsText {
    heading,
    testimonials[] {
      text,
      author,
      role
    }
  },
  communityImageText {
    title,
    description,
    image { asset->{ _id, url } }
  }
}`;

const data = await sanityClient.fetch(QUERY);

const heroText = {
  image: withDefaultImage(data?.heroText?.image, DEFAULT_IMAGES.hero),
  badge: data?.heroText?.badge ?? '',
  headingPrefix: data?.heroText?.headingPrefix ?? '',
  headingHighlight: data?.heroText?.headingHighlight ?? '',
  subheading: data?.heroText?.subheading ?? '',
};

const creeksideDifferenceText = {
  heading: data?.creeksideDifferenceText?.heading ?? '',
  body: data?.creeksideDifferenceText?.body ?? '',
  image: withDefaultImage(data?.creeksideDifferenceText?.image, DEFAULT_IMAGES.creeksideDifference),
};

const ourPillarsText = {
  heading: data?.ourPillarsText?.heading ?? '',
  subheading: data?.ourPillarsText?.subheading ?? '',
  pillars: data?.ourPillarsText?.pillars ?? [],
};

const communityPartnersText = {
  heading: data?.communityPartnersText?.heading ?? '',
  partners: data?.communityPartnersText?.partners ?? [],
};

const navigationGridText = {
  heading: data?.navigationGridText?.heading ?? '',
  linkLabel: data?.navigationGridText?.linkLabel ?? '',
  items: data?.navigationGridText?.items ?? [],
};

const testimonialsText = {
  heading: data?.testimonialsText?.heading ?? '',
  testimonials: data?.testimonialsText?.testimonials ?? [],
};

---

<HomeLayout title={data?.title ?? ''}>
  <div class="animate-fade-in font-sans">
    <HeroSection {...heroText} />
    <CreeksideDifference {...creeksideDifferenceText} />
    <OurPillars {...ourPillarsText} />
    <CommunityPartners {...communityPartnersText} />
    <NavigationGrid {...navigationGridText} />
    <Testimonials {...testimonialsText} />
  </div>
</HomeLayout>
