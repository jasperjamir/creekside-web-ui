---
import { sanityClient } from "sanity:client";
import PageLayout from '../../layouts/PageLayout.astro';
import OurStory from './sections/our-story.astro';
import LifelongLearning from './sections/lifelong-learning.astro';
import MissionVision from './sections/mission-vision.astro';
import OurTeam from './sections/our-team.astro';
import WhatIsProfoundAutism from './sections/what-is-profound-autism.astro';
import { ASSETS_BASE_URL } from '../../constants';

const DEFAULT_IMAGES = {
  ourStory: {
    url: `${ASSETS_BASE_URL}/images/who-we-are--we-are-a-community.png`,
    alt: 'Creekside School - staff or campus',
  },
  lifelongLearning: {
    url: `${ASSETS_BASE_URL}/images/who-we-are--lifelong-learning.jpg`,
    alt: 'Lifelong learning at Creekside',
  },
  missionVision: {
    url: `${ASSETS_BASE_URL}/images/who-we-are--mission-vision.jpg`,
    alt: 'Mission and Vision',
  },
  whatIsProfoundAutism: {
    url: `${ASSETS_BASE_URL}/images/who-we-are--profound-autism.jpg`,
    alt: 'What is profound autism',
  },
};

function withDefaultImage(
  cmsImage: { asset?: { url: string }; alt?: string } | undefined,
  defaultImage: { url: string; alt: string }
) {
  if (cmsImage?.asset?.url) {
    return { asset: { url: cmsImage.asset.url }, alt: defaultImage.alt };
  }
  return { asset: { url: defaultImage.url }, alt: defaultImage.alt };
}

const QUERY = /* groq */ `*[_type == "whoWeAre"][0] {
  title,
  ourStoryText {
    heading,
    body,
    body2,
    image { asset->{ _id, url } }
  },
  lifelongLearningText {
    headline,
    subheading,
    body,
    image { asset->{ _id, url } }
  },
  missionVisionText {
    sectionHeading,
    mission,
    vision,
    image { asset->{ _id, url } }
  },
  ourTeamText {
    sectionHeading,
    groups[] {
      title,
      description,
      images[] { asset->{ _id, url } }
    }
  },
  whatIsProfoundAutismText {
    sectionHeading,
    definition,
    image { asset->{ _id, url } }
  }
}`;

const data = await sanityClient.fetch(QUERY);

const content = {
  pageTitle: data?.title ?? '',
  ourStory: {
    heading: data?.ourStoryText?.heading ?? '',
    body: data?.ourStoryText?.body ?? '',
    body2: data?.ourStoryText?.body2 ?? '',
    image: withDefaultImage(data?.ourStoryText?.image, DEFAULT_IMAGES.ourStory),
  },
  lifelongLearning: {
    headline: data?.lifelongLearningText?.headline ?? '',
    subheading: data?.lifelongLearningText?.subheading ?? '',
    body: data?.lifelongLearningText?.body ?? '',
    image: withDefaultImage(data?.lifelongLearningText?.image, DEFAULT_IMAGES.lifelongLearning),
  },
  missionVision: {
    sectionHeading: data?.missionVisionText?.sectionHeading ?? '',
    mission: data?.missionVisionText?.mission ?? '',
    vision: data?.missionVisionText?.vision ?? '',
    image: withDefaultImage(data?.missionVisionText?.image, DEFAULT_IMAGES.missionVision),
  },
  ourTeam: {
    sectionHeading: data?.ourTeamText?.sectionHeading ?? '',
    groups: data?.ourTeamText?.groups ?? [],
  },
  whatIsProfoundAutism: {
    sectionHeading: data?.whatIsProfoundAutismText?.sectionHeading ?? '',
    definition: data?.whatIsProfoundAutismText?.definition ?? '',
    image: withDefaultImage(data?.whatIsProfoundAutismText?.image, DEFAULT_IMAGES.whatIsProfoundAutism),
  },
};
---

<PageLayout title={content.pageTitle}>
  <div class="animate-fade-in font-sans">
    <OurStory {...content.ourStory} />
    <LifelongLearning {...content.lifelongLearning} />
    <MissionVision {...content.missionVision} />
    <OurTeam sectionHeading={content.ourTeam.sectionHeading} groups={content.ourTeam.groups} />
    <WhatIsProfoundAutism {...content.whatIsProfoundAutism} />
  </div>
</PageLayout>
