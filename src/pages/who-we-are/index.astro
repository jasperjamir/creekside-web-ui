---
import { sanityClient } from "sanity:client";
import PageLayout from '../../layouts/PageLayout.astro';
import OurStory from './_sections/our-story.astro';
import LifelongLearning from './_sections/lifelong-learning.astro';
import MissionVision from './_sections/mission-vision.astro';
import OurTeam from './_sections/our-team.astro';
import WhatIsProfoundAutism from './_sections/what-is-profound-autism.astro';
import { DEFAULT_IMAGES, DEFAULT_CONTENT } from './_constants';

function withDefaultImage(
  cmsImage: { asset?: { url: string }; alt?: string } | undefined,
  defaultImage: { url: string; alt: string }
) {
  if (cmsImage?.asset?.url) {
    return { asset: { url: cmsImage.asset.url }, alt: defaultImage.alt };
  }
  return { asset: { url: defaultImage.url }, alt: defaultImage.alt };
}

const QUERY = /* groq */ `*[_type == "whoWeAre"][0] {
  title,
  ourStoryText {
    heading,
    body,
    body2,
    image { asset->{ _id, url } }
  },
  lifelongLearningText {
    headline,
    subheading,
    body,
    image { asset->{ _id, url } }
  },
  missionVisionText {
    sectionHeading,
    mission,
    vision,
    image { asset->{ _id, url } }
  },
  ourTeamText {
    sectionHeading,
    groups[] {
      title,
      description,
      images[] { asset->{ _id, url } }
    }
  },
  whatIsProfoundAutismText {
    sectionHeading,
    definition,
    image { asset->{ _id, url } }
  }
}`;

const data = await sanityClient.fetch(QUERY);

const d = DEFAULT_CONTENT;
const content = {
  pageTitle: data?.title ?? d.pageTitle,
  ourStory: {
    heading: data?.ourStoryText?.heading ?? d.ourStory.heading,
    body: data?.ourStoryText?.body ?? d.ourStory.body,
    body2: data?.ourStoryText?.body2 ?? d.ourStory.body2,
    image: withDefaultImage(data?.ourStoryText?.image, DEFAULT_IMAGES.ourStory),
  },
  lifelongLearning: {
    headline: data?.lifelongLearningText?.headline ?? d.lifelongLearning.headline,
    subheading: data?.lifelongLearningText?.subheading ?? d.lifelongLearning.subheading,
    body: data?.lifelongLearningText?.body ?? d.lifelongLearning.body,
    image: withDefaultImage(data?.lifelongLearningText?.image, DEFAULT_IMAGES.lifelongLearning),
  },
  missionVision: {
    sectionHeading: data?.missionVisionText?.sectionHeading ?? d.missionVision.sectionHeading,
    mission: data?.missionVisionText?.mission ?? d.missionVision.mission,
    vision: data?.missionVisionText?.vision ?? d.missionVision.vision,
    image: withDefaultImage(data?.missionVisionText?.image, DEFAULT_IMAGES.missionVision),
  },
  ourTeam: {
    sectionHeading: data?.ourTeamText?.sectionHeading ?? d.ourTeam.sectionHeading,
    groups: data?.ourTeamText?.groups ?? d.ourTeam.groups,
  },
  whatIsProfoundAutism: {
    sectionHeading: data?.whatIsProfoundAutismText?.sectionHeading ?? d.whatIsProfoundAutism.sectionHeading,
    definition: data?.whatIsProfoundAutismText?.definition ?? d.whatIsProfoundAutism.definition,
    image: withDefaultImage(data?.whatIsProfoundAutismText?.image, DEFAULT_IMAGES.whatIsProfoundAutism),
  },
};
---

<PageLayout title={content.pageTitle || 'Who We Are - The Creekside School'}>
  <div class="animate-fade-in font-sans">
    <OurStory {...content.ourStory} />
    <LifelongLearning {...content.lifelongLearning} />
    <MissionVision {...content.missionVision} />
    <OurTeam sectionHeading={content.ourTeam.sectionHeading} groups={content.ourTeam.groups} />
    <WhatIsProfoundAutism {...content.whatIsProfoundAutism} />
  </div>
</PageLayout>
